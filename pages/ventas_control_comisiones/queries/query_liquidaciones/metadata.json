{
  "gitSyncId": "68bf46d3c4f12e2bf17c39f9_728e2845-b630-4791-9dff-83cdcee24898",
  "id": "ventas_control_comisiones_query_liquidaciones",
  "pluginId": "postgres-plugin",
  "pluginType": "DB",
  "unpublishedAction": {
    "actionConfiguration": {
      "body": "WITH cte_main AS (\n    SELECT \n        a.manage_id,\n        a.id_nomina,\n        a.idcampa,\n        a.proveedor,\n        a.auditor,\n        a.fecha_registro,\n        a.fecha_liquidacion,\n        a.fecha_descuento,\n        a.fecha_activacion_vigente,\n        a.fecha_desconexion_vigente,\n        a.fecha_vigente,\n        a.fecha_instalacion,\n        a.idestado_actual,\n        a.id_ult_estado_cierre_mes_creacion,\n        a.codigo_crm_cliente,\n        a.dni_cliente,\n        a.tpo_servicio,\n        a.meses_diferencia,\n        a.fecha_comision,\n        a.fecha_descomision,\n        a.total_active_sales_for_group,\n        a.monto,\n        a.id_comision,\n        a.prod_adicionales,\n        a.comision_original,\n        a.comision_total,\n        a.fecha_liquidacion_impacto,\n        a.indicador,\n        a.estado,\n        a.liquidacion,\n        CONCAT(a.idcampa::TEXT, '-', a.fecha_liquidacion_impacto::TEXT, '-', a.proveedor::TEXT) AS cod_unico_corte,\n        b.date_edit AS ultima_edicion,\n        a.observacion,\n        a.commision_adjustment\n    FROM vw_total_comisiones_alarmas a\n    INNER JOIN sales_management.fact_sales b ON b.manage_id = a.manage_id\n\n    UNION ALL\n\n    SELECT\n        manage_id,\n        id_nomina,\n        idcampa,\n        proveedor,\n        auditor,\n        fecha_registro,\n        fecha_liquidacion,\n        fecha_descuento,\n        fecha_activacion_vigente,\n        fecha_desconexion_vigente,\n        fecha_vigente,\n        NULL::DATE AS fecha_instalacion,\n        idestado_actual,\n        id_ult_estado_cierre_mes_creacion,\n        codigo_crm_cliente,\n        dni_cliente,\n        tpo_servicio,\n        meses_diferencia,\n        fecha_comision,\n        fecha_descomision,\n        total_active_sales_for_group,\n        monto,\n        id_comision,\n        prod_adicionales,\n        comision_total AS comision_original,\n        comision_total_ajustada AS comision_total,\n        fecha_liquidacion_impacto,\n        indicador,\n        estado,\n        liquidacion,\n        cod_unico_corte::TEXT,\n        ultima_edicion,\n        observacion,\n        commision_adjustment\n    FROM test_ong_comisiones\n),\ncte_main_2 AS (\n    SELECT a.*\n    FROM cte_main a\n    WHERE a.idcampa = {{List1.selectedItem.idcampa√±a}}\n),\ncte_aggregated AS (\n    SELECT \n        fecha_liquidacion_impacto,\n        proveedor,\n        SUM(CASE WHEN indicador = 'COMISION' THEN COALESCE(comision_total,0) ELSE 0 END) AS comision,\n        SUM(CASE WHEN indicador = 'DESCOMISION' THEN COALESCE(comision_total,0) ELSE 0 END) AS descomision,\n        SUM(CASE WHEN indicador = 'IMPAGO' THEN COALESCE(comision_total,0) ELSE 0 END) AS impago,\n        SUM(CASE WHEN indicador = 'IMPAGO_REGULARIZADO' THEN COALESCE(comision_total,0) ELSE 0 END) AS impago_regularizado,\n        SUM(CASE WHEN indicador = 'DESCUENTO GENERAL' THEN COALESCE(comision_total,0) ELSE 0 END) AS descuento_general,\n        SUM(CASE WHEN indicador = 'COMISION ADICIONAL' THEN COALESCE(comision_total,0) ELSE 0 END) AS comision_adicional\n    FROM cte_main_2\n    GROUP BY fecha_liquidacion_impacto, proveedor\n)\nSELECT \n    fecha_liquidacion_impacto,\n    proveedor,\n    (comision \n     - descomision \n     - impago \n     + impago_regularizado \n     - descuento_general \n     + comision_adicional) AS liquidacion_total\nFROM cte_aggregated\nORDER BY fecha_liquidacion_impacto, proveedor;",
      "encodeParamsToggle": true,
      "paginationType": "NONE",
      "pluginSpecifiedTemplates": [
        {
          "value": true
        }
      ],
      "timeoutInMillisecond": 10000
    },
    "confirmBeforeExecute": false,
    "datasource": {
      "id": "bi_dimension",
      "isAutoGenerated": false,
      "name": "bi_dimension",
      "pluginId": "postgres-plugin"
    },
    "dynamicBindingPathList": [
      {
        "key": "body"
      }
    ],
    "name": "query_liquidaciones",
    "pageId": "ventas_control_comisiones",
    "runBehaviour": "MANUAL",
    "userSetOnLoad": false
  }
}