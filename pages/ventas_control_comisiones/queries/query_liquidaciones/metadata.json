{
  "gitSyncId": "68bf46d3c4f12e2bf17c39f9_728e2845-b630-4791-9dff-83cdcee24898",
  "id": "ventas_control_comisiones_query_liquidaciones",
  "pluginId": "postgres-plugin",
  "pluginType": "DB",
  "unpublishedAction": {
    "actionConfiguration": {
      "body": "WITH cte_main AS (\n\tSELECT \n\ta.manage_id,\n\ta.id_nomina,\n\ta.idcampa,\n\ta.proveedor,\n\ta.auditor,\n\ta.fecha_registro,\n\ta.fecha_liquidacion,\n\ta.fecha_descuento,\n\ta.fecha_activacion_vigente,\n\ta.fecha_desconexion_vigente,\n\ta.fecha_vigente,\n\ta.fecha_instalacion,\n\ta.idestado_actual,\n\ta.id_ult_estado_cierre_mes_creacion,\n\ta.codigo_crm_cliente,\n\ta.dni_cliente,\n\ta.tpo_servicio,\n\ta.meses_diferencia,\n\ta.fecha_comision,\n\ta.fecha_descomision,\n\ta.total_active_sales_for_group,\n\ta.monto,\n\ta.id_comision,\n\ta.prod_adicionales,\n\ta.comision_original,\n\ta.comision_total,\n\ta.fecha_liquidacion_impacto,\n\ta.indicador,\n\ta.estado,\n\ta.liquidacion,\n\tCONCAT(a.idcampa::TEXT, '-', a.fecha_liquidacion_impacto::TEXT, '-', a.proveedor::TEXT) AS cod_unico_corte,\n\tb.date_edit AS ultima_edicion,\n\ta.observacion,\n\ta.commision_adjustment\n\tFROM vw_total_comisiones_alarmas a\n\tINNER JOIN sales_management.fact_sales b ON b.manage_id = a.manage_id\n\n\tUNION ALL\n\n\tSELECT\n\tmanage_id,\n\tid_nomina,\n\tidcampa,\n\tproveedor,\n\tauditor,\n\tfecha_registro,\n\tfecha_liquidacion,\n\tfecha_descuento,\n\tfecha_activacion_vigente,\n\tfecha_desconexion_vigente,\n\tfecha_vigente,\n\tNULL::DATE AS fecha_instalacion,\n\tidestado_actual,\n\tid_ult_estado_cierre_mes_creacion,\n\tcodigo_crm_cliente,\n\tdni_cliente,\n\ttpo_servicio,\n\tmeses_diferencia,\n\tfecha_comision,\n\tfecha_descomision,\n\ttotal_active_sales_for_group,\n\tmonto,\n\tid_comision,\n\tprod_adicionales,\n\tcomision_total AS comision_original,\n\tcomision_total_ajustada AS comision_total,\n\tfecha_liquidacion_impacto,\n\tindicador,\n\testado,\n\tliquidacion,\n\tcod_unico_corte::TEXT,\n\tultima_edicion,\n\tobservacion,\n\tcommision_adjustment\n\tFROM test_ong_comisiones\n\tUNION ALL\n\tSELECT *\n\tFROM commission_management.vw_commission_enerco\n\tUNION ALL\n\tSELECT *\n\tFROM commission_management.vw_commission_naturgy_omnicanal\n\tUNION ALL\n\tSELECT *\n\tFROM \n\tcommission_management.vw_commission_energia_repsol\n\n),\ncte_main_2 AS (\n\tSELECT a.*\n\tFROM cte_main a\n\tWHERE a.idcampa = {{List1.selectedItem.idcampa√±a}}\n),\ncte_aggregated AS (\n\tSELECT \n\tfecha_liquidacion_impacto,\n\tproveedor,\n\tSUM(CASE WHEN indicador = 'COMISION' THEN COALESCE(comision_total,0) ELSE 0 END) AS comision,\n\tSUM(CASE WHEN indicador = 'DESCOMISION' THEN COALESCE(comision_total,0) ELSE 0 END) AS descomision,\n\tSUM(CASE WHEN indicador = 'IMPAGO' THEN COALESCE(comision_total,0) ELSE 0 END) AS impago,\n\tSUM(CASE WHEN indicador = 'IMPAGO_REGULARIZADO' THEN COALESCE(comision_total,0) ELSE 0 END) AS impago_regularizado,\n\tSUM(CASE WHEN indicador = 'DESCUENTO GENERAL' THEN COALESCE(comision_total,0) ELSE 0 END) AS descuento_general,\n\tSUM(CASE WHEN indicador = 'COMISION ADICIONAL' THEN COALESCE(comision_total,0) ELSE 0 END) AS comision_adicional\n\tFROM cte_main_2\n\tGROUP BY fecha_liquidacion_impacto, proveedor\n)\nSELECT \n    fecha_liquidacion_impacto,\n    proveedor,\n    (comision \n\t\t - descomision \n\t\t - impago \n\t\t + impago_regularizado \n\t\t - descuento_general \n\t\t + comision_adicional) AS liquidacion_total\nFROM cte_aggregated\nORDER BY fecha_liquidacion_impacto, proveedor;",
      "encodeParamsToggle": true,
      "paginationType": "NONE",
      "pluginSpecifiedTemplates": [
        {
          "value": true
        }
      ],
      "timeoutInMillisecond": 10000
    },
    "confirmBeforeExecute": false,
    "datasource": {
      "id": "bi_dimension",
      "isAutoGenerated": false,
      "name": "bi_dimension",
      "pluginId": "postgres-plugin"
    },
    "dynamicBindingPathList": [
      {
        "key": "body"
      }
    ],
    "name": "query_liquidaciones",
    "pageId": "ventas_control_comisiones",
    "runBehaviour": "MANUAL",
    "userSetOnLoad": false
  }
}